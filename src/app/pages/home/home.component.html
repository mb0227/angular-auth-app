<div class="p-6 max-w-5xl mx-auto" *ngIf="!loading; else loadingTpl">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">Welcome {{ user?.username }}</h1>
    <div class="flex gap-4">
      <button class="text-red-600 underline" (click)="onDeleteAccount()">Delete Account</button>
      <button class="text-gray-700 underline" (click)="onSignOut()">Sign Out</button>
    </div>
  </div>

  <div class="grid md:grid-cols-3 gap-6">
    <form (submit)="onSaveProfile($event)" class="border rounded p-4 md:col-span-2">
      <h2 class="font-semibold mb-4">Profile (multipart upload)</h2>
      <label class="block text-sm mb-1">Username</label>
      <input [(ngModel)]="username" name="username" class="border p-2 w-full mb-3 rounded" />

      <label class="block text-sm mb-1">Avatar</label>
      <input type="file" class="mb-4" (change)="onFileChange($event)" accept="image/*" />

      <button [disabled]="profileSaving" class="bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50">
        {{ profileSaving ? 'Saving...' : 'Save Changes' }}
      </button>
    </form>

    <div class="border rounded p-4">
      <h2 class="font-semibold mb-4">Current Profile Image</h2>
      <div *ngIf="imageLoading">Loading image...</div>
      <img *ngIf="!imageLoading && profileImageUrl" [src]="profileImageUrl" alt="Profile" class="w-32 h-32 object-cover rounded-full border" />
      <div *ngIf="!imageLoading && !profileImageUrl" class="text-sm text-gray-500">No image</div>
      <button class="mt-3 text-blue-600 underline" (click)="refreshProfileImage()">Refresh</button>
    </div>

    <form (submit)="onSaveBase64($event)" class="border rounded p-4">
      <h2 class="font-semibold mb-4">Update Image (base64)</h2>
      <input type="file" class="mb-3" (change)="onB64FileChange($event)" accept="image/*" />
      <button [disabled]="b64Uploading" class="bg-gray-800 text-white px-4 py-2 rounded disabled:opacity-50">
        {{ b64Uploading ? 'Uploading...' : 'Save Image' }}
      </button>
    </form>

    <form (submit)="onChangePassword($event)" class="border rounded p-4">
      <h2 class="font-semibold mb-4">Change Password</h2>
      <label class="block text-sm mb-1">Old Password</label>
      <input [(ngModel)]="pwd.OldPassword" name="oldPassword" type="password" class="border p-2 w-full mb-3 rounded" />
      <label class="block text-sm mb-1">New Password</label>
      <input [(ngModel)]="pwd.NewPassword" name="newPassword" type="password" class="border p-2 w-full mb-4 rounded" />
      <button [disabled]="pwdLoading" class="bg-gray-800 text-white px-4 py-2 rounded disabled:opacity-50">
        {{ pwdLoading ? 'Updating...' : 'Update Password' }}
      </button>
    </form>

    <form (submit)="onUpdateAll($event)" class="border rounded p-4 md:col-span-2">
      <h2 class="font-semibold mb-4">Update User (PUT)</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input [(ngModel)]="updateAll.username" name="allUsername" class="border p-2 w-full mb-3 rounded" />
        </div>
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input [(ngModel)]="updateAll.email" name="allEmail" type="email" class="border p-2 w-full mb-3 rounded" />
        </div>
        <div>
          <label class="block text-sm mb-1">Password</label>
          <input [(ngModel)]="updateAll.password" name="allPassword" type="password" class="border p-2 w-full mb-3 rounded" />
        </div>
      </div>
      <button [disabled]="updateAllLoading" class="bg-green-600 text-white px-4 py-2 rounded disabled:opacity-50">
        {{ updateAllLoading ? 'Updating...' : 'Update User' }}
      </button>
    </form>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="p-6">Loading...</div>
</ng-template>